#!/usr/bin/python3
from pathlib import Path
cfgDir = Path(__file__).resolve().parent.parent.parent
cfgFile = cfgDir/ 'cfg.py'
with open(str(cfgFile)) as _: exec(_.read())

import subprocess

from handyPyUtil.tests import TestKit
from handyPyUtil.subproc import Pipe

def doTest(case):
    with TestKit() as tk:
        tmpDir = tk.tmpDir
        f = tmpDir / "myScript.py"

        subdir = tmpDir / 'subdir'
        subdir.mkdir()

        (tmpDir / '.project_root').write_text("\n")
        (subdir / 'subfile.py').write_text("\n")

        # create a symlink to handyPyUtil cfg.py in tmpDir
        cfgLinkName = case['cfgLinkName']
        if cfgLinkName:
            l = tmpDir / cfgLinkName
            l.symlink_to(cfgFile)

        f.write_text(f"""
{case['importCode']}

inclPath('subdir')

import subfile
import handyPyUtil
""")

        p = Pipe(['python3', str(f)])
        if p.status:
            print(p.stderr)
        assert not p.status


cases = [
    {
        'cfgLinkName': None,
        'importCode': f"""
from pathlib import Path
with open("{str(cfgFile)}") as _: exec(_.read())
""",
    }, {
        'cfgLinkName': "cfg.py",
        'importCode': f"""
from pathlib import Path as P; E=P.exists;R=P.resolve; l=R(P(__file__)).parents
with open(R(next(filter(E,(p/'cfg.py' for p in l))))) as _:exec(_.read())
""",
    }, {
        'cfgLinkName': "my_cfg_link.py",
        'importCode': f"""
from pathlib import Path as P; E=P.exists;R=P.resolve; l=R(P(__file__)).parents
with open(R(next(filter(E,(p/'my_cfg_link.py' for p in l))))) as _:exec(_.read())
""",
    },
]

for case in cases:
    doTest(case)
